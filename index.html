<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>四週變形工時、月排班檢查工具(測試版)</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="excelExporter.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", Arial, sans-serif;
      background: #eef2f7;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #0b5ed7;
    }
    #info-toggle {
      cursor: pointer;
      color: #0d6efd;
      text-align: center;
      margin: 10px 0;
    }
    #info-toggle:hover {
      text-decoration: underline;
    }
    #info-content {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      max-width: 900px;
      margin: 0 auto 20px auto;
    }
    button {
      background-color: #0d6efd;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #0b5ed7;
    }
    .group-block {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .group-block input {
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .code-list {
      list-style: none;
      padding-left: 0;
    }
    .code-list li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>四週變形工時、月排班檢查工具(測試版)</h1>

  <div id="info-toggle">※說明 (點擊展開/收合)</div>
  <div id="info-content">
    <p><font color=red>本網頁可編輯，週期班表與月班表資料同步，即時計算班數</font></p>
    <p>檢查功能包含：</p>
    <ul>
      <li>1.四週變形工時：</li>
      *四週中，前2週和後2週，都分別要有 2 個 FF。<br>
      *週內總計至少有 4 個 WW 或 W+<br>
      *任意 FF 與下一個 FF 間隔不可超過 12 天（跨週期檢查，超過會提示）。<br>
      <li>2.月排班：</li>
      *計算當月OFF總數(含FF、WW、VV、SS)<br>
      *FF 數量應 ≧ 當月星期日數，WW 數量應 ≧ 當月星期六數。<br>
      *計算六、日放假天數<br>
      *計算小夜、大夜班數<br>
    </ul>
    <p>班別代號：</p>
    <ul>
      <li>白小大代號：白班8、小夜4、大夜12</li>
      <li>W+代號：白班8W、小夜4W、DLW、5GW、大夜12W</li>
    </ul>
    <p>班表格式：</p>
    <ul>
      <li>前兩列(橫)為日期與星期。</li>
      <li>前三欄(直)為職編、姓名、備註。</li>
      <li>班表的內容從 D3 開始。</li>
      <li>本網頁只讀取第一個工作表(sheet)。</li>
    </ul>
  </div>

  <div id="modeSelector" style="margin-bottom: 10px;">
    <label><input type="checkbox" id="checkboxWeekly" /> 四週變形工時</label>
    <label><input type="checkbox" id="checkboxMonthly" /> 月排班</label>
  </div>

  <div id="settingPanel" style="margin-bottom: 20px;">
    <label for="periodStartSelector">📅 檢查起始日：</label>
    <select id="periodStartSelector"></select>

    <label for="periodCountSelector">🔢 週期數：</label>
    <select id="periodCountSelector"></select>

    <label for="monthSelector">🗓️ 檢查月份：</label>
    <select id="monthSelector"></select>
  </div>

  <input type="file" id="excelFile" accept=".xls,.xlsx" />
  <button onclick="exportScheduleToExcel()">📤 匯出班表結果</button>
  <button onclick="toggleSettingPanel()">⚙️ 設定</button>

  <div id="customShiftSetting" style="display:none; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-top:10px;">
    <h3>自訂班別代號（週期與月統計共用）</h3>
    <div id="shiftGroupEditor"></div>
    <button onclick="saveShiftGroups()">💾 儲存設定</button>
  </div>

  <div id="weeklyTableContainer" class="table-container"></div>
  <div id="monthlyTableContainer" class="table-container"></div>

  <script src="config.js"></script>
  <script src="periodStartSelector.js"></script>
  <script src="periodCountSelector.js"></script>
  <script src="monthSelector.js"></script>
  <script src="ui.js"></script>
  <script src="excelLoader.js"></script>
  <script src="tableRenderer.js"></script>
  <script src="checker.js"></script>
  <script src="modeSelector.js"></script>

  <script>
    window.onload = function () {
      const today = new Date();
      renderPeriodStartSelector(today);
      renderPeriodCountSelector();
      renderMonthSelector();
      initModeSelector();

      window.scheduleState = {
        startDate: document.getElementById("periodStartSelector").value,
        periodCount: parseInt(document.getElementById("periodCountSelector").value, 10),
        monthStr: document.getElementById("monthSelector").value,
        selectedRows: []
      };
    };

    ["periodCountSelector", "periodStartSelector", "monthSelector"].forEach(id => {
      document.getElementById(id).addEventListener("change", () => {
        const state = window.scheduleState;
        state.startDate = document.getElementById("periodStartSelector").value;
        state.periodCount = parseInt(document.getElementById("periodCountSelector").value, 10);
        state.monthStr = document.getElementById("monthSelector").value;

        if (state.selectedRows.length && typeof window.renderScheduleTable === "function") {
          window.renderScheduleTable(state.selectedRows);
        }
      });
    });

    document.getElementById("excelFile").addEventListener("change", function () {
      if (this.files.length > 0) {
        handleExcelImport();
      }
    });

    document.getElementById("checkboxWeekly").addEventListener("change", () => {
      if (window.scheduleState?.selectedRows?.length) {
        window.renderScheduleTable(window.scheduleState.selectedRows);
      }
    });

    document.getElementById("checkboxMonthly").addEventListener("change", () => {
      if (window.scheduleState?.selectedRows?.length) {
        window.renderScheduleTable(window.scheduleState.selectedRows);
      }
    });

    document.getElementById("info-toggle").addEventListener("click", function () {
      const infoContent = document.getElementById("info-content");
      infoContent.style.display = (infoContent.style.display === "none" || infoContent.style.display === "") ? "block" : "none";
    });

    // ✅ 自訂班別代號設定（共用於週期與月統計）
    const fixedShiftFields = ["OFF", "WW", "小夜", "大夜"];

    const defaultShiftGroups = {
      OFF: ["FF", "WW", "VV", "SS"],
      WW: ["WW", "4W", "8W", "12W", "DLW", "5GW"],
      小夜: ["4", "4N", "4N1"],
      大夜: ["12", "12W"]
    };

    function loadShiftGroups() {
      const raw = localStorage.getItem("shiftGroups");
      try {
        const parsed = raw ? JSON.parse(raw) : structuredClone(defaultShiftGroups);
        fixedShiftFields.forEach(field => {
          if (!parsed[field]) parsed[field] = structuredClone(defaultShiftGroups[field]);
        });
        return parsed;
      } catch {
        return structuredClone(defaultShiftGroups);
      }
    }

    function saveShiftGroupsToLocal(groups) {
      localStorage.setItem("shiftGroups", JSON.stringify(groups));
    }

    function toggleSettingPanel() {
      const panel = document.getElementById("customShiftSetting");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
      renderShiftGroupEditor();
    }

    function renderShiftGroupEditor() {
      const groups = loadShiftGroups();
      const container = document.getElementById("shiftGroupEditor");
      container.innerHTML = "";

      fixedShiftFields.forEach(field => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-block";

        const label = document.createElement("div");
        label.textContent = `欄位名稱：${field}`;
        label.style.fontWeight = "bold";
        label.style.marginBottom = "6px";

        const codeList = document.createElement("ul");
        codeList.className = "code-list";

        groups[field].forEach(code => {
          const li = document.createElement("li");
          li.innerHTML = `
            <input type="text" value="${code}" class="code-input" />
            <button onclick="removeCode(this)">🗑️</button>
          `;
          codeList.appendChild(li);
        });

        const addCodeBtn = document.createElement("button");
        addCodeBtn.textContent = "➕ 新增代號";
        addCodeBtn.onclick = () => {
          const li = document.createElement("li");
          li.innerHTML = `
            <input type="text" value="" class="code-input" />
            <button onclick="removeCode(this)">🗑️</button>
          `;
          codeList.appendChild(li);
        };

        groupDiv.appendChild(label);
        groupDiv.appendChild(codeList);
        groupDiv.appendChild(addCodeBtn);
        container.appendChild(groupDiv);
      });
    }

    function removeCode(btn) {
      const li = btn.parentElement;
      const ul = li.parentElement;
      if (ul.querySelectorAll("li").length > 1) {
        ul.removeChild(li);
      } else {
        alert("每項至少保留一個代號！");
      }
    }

    function saveShiftGroups() {
      const groupBlocks = document.querySelectorAll(".group-block");
      const newGroups = {};

      groupBlocks.forEach((block, index) => {
        const field = fixedShiftFields[index];
        const codes = Array.from(block.querySelectorAll(".code-input"))
          .map(input => input.value.trim())
          .filter(Boolean);

        if (codes.length > 0) {
          newGroups[field] = codes;
        } else {
          alert(`欄位「${field}」至少要有一個代號！`);
          return;
        }
      });

      saveShiftGroupsToLocal(newGroups);
      alert("✅ 班別設定已儲存！");
  // 👉 新增這一行：儲存後關閉設定面板
  document.getElementById("customShiftSetting").style.display = "none";

    }
  </script>
</body>
</html>