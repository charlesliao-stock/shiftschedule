<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å››é€±è®Šå½¢å·¥æ™‚ã€æœˆæ’ç­æª¢æŸ¥å·¥å…·(æ¸¬è©¦ç‰ˆ)</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="excelExporter.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", Arial, sans-serif;
      background: #eef2f7;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #0b5ed7;
    }
    #info-toggle {
      cursor: pointer;
      color: #0d6efd;
      text-align: center;
      margin: 10px 0;
    }
    #info-toggle:hover {
      text-decoration: underline;
    }
    #info-content {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      max-width: 900px;
      margin: 0 auto 20px auto;
    }
    button {
      background-color: #0d6efd;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #0b5ed7;
    }
    .group-block {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .group-block input {
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .code-list {
      list-style: none;
      padding-left: 0;
    }
    .code-list li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>å››é€±è®Šå½¢å·¥æ™‚ã€æœˆæ’ç­æª¢æŸ¥å·¥å…·(æ¸¬è©¦ç‰ˆ)</h1>

  <div id="info-toggle">â€»èªªæ˜ (é»æ“Šå±•é–‹/æ”¶åˆ)</div>
  <div id="info-content">
    <p><font color=red>æœ¬ç¶²é å¯ç·¨è¼¯ï¼Œé€±æœŸç­è¡¨èˆ‡æœˆç­è¡¨è³‡æ–™åŒæ­¥ï¼Œå³æ™‚è¨ˆç®—ç­æ•¸</font></p>
    <p>æª¢æŸ¥åŠŸèƒ½åŒ…å«ï¼š</p>
    <ul>
      <li>1.å››é€±è®Šå½¢å·¥æ™‚ï¼š</li>
      *å››é€±ä¸­ï¼Œå‰2é€±å’Œå¾Œ2é€±ï¼Œéƒ½åˆ†åˆ¥è¦æœ‰ 2 å€‹ FFã€‚<br>
      *é€±å…§ç¸½è¨ˆè‡³å°‘æœ‰ 4 å€‹ WW æˆ– W+<br>
      *ä»»æ„ FF èˆ‡ä¸‹ä¸€å€‹ FF é–“éš”ä¸å¯è¶…é 12 å¤©ï¼ˆè·¨é€±æœŸæª¢æŸ¥ï¼Œè¶…éæœƒæç¤ºï¼‰ã€‚<br>
      <li>2.æœˆæ’ç­ï¼š</li>
      *è¨ˆç®—ç•¶æœˆOFFç¸½æ•¸(å«FFã€WWã€VVã€SS)<br>
      *FF æ•¸é‡æ‡‰ â‰§ ç•¶æœˆæ˜ŸæœŸæ—¥æ•¸ï¼ŒWW æ•¸é‡æ‡‰ â‰§ ç•¶æœˆæ˜ŸæœŸå…­æ•¸ã€‚<br>
      *è¨ˆç®—å…­ã€æ—¥æ”¾å‡å¤©æ•¸<br>
      *è¨ˆç®—å°å¤œã€å¤§å¤œç­æ•¸<br>
    </ul>
    <p>ç­åˆ¥ä»£è™Ÿï¼š</p>
    <ul>
      <li>ç™½å°å¤§ä»£è™Ÿï¼šç™½ç­8ã€å°å¤œ4ã€å¤§å¤œ12</li>
      <li>W+ä»£è™Ÿï¼šç™½ç­8Wã€å°å¤œ4Wã€DLWã€5GWã€å¤§å¤œ12W</li>
    </ul>
    <p>ç­è¡¨æ ¼å¼ï¼š</p>
    <ul>
      <li>å‰å…©åˆ—(æ©«)ç‚ºæ—¥æœŸèˆ‡æ˜ŸæœŸã€‚</li>
      <li>å‰ä¸‰æ¬„(ç›´)ç‚ºè·ç·¨ã€å§“åã€å‚™è¨»ã€‚</li>
      <li>ç­è¡¨çš„å…§å®¹å¾ D3 é–‹å§‹ã€‚</li>
      <li>æœ¬ç¶²é åªè®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨(sheet)ã€‚</li>
    </ul>
  </div>

  <div id="modeSelector" style="margin-bottom: 10px;">
    <label><input type="checkbox" id="checkboxWeekly" /> å››é€±è®Šå½¢å·¥æ™‚</label>
    <label><input type="checkbox" id="checkboxMonthly" /> æœˆæ’ç­</label>
  </div>

  <div id="settingPanel" style="margin-bottom: 20px;">
    <label for="periodStartSelector">ğŸ“… æª¢æŸ¥èµ·å§‹æ—¥ï¼š</label>
    <select id="periodStartSelector"></select>

    <label for="periodCountSelector">ğŸ”¢ é€±æœŸæ•¸ï¼š</label>
    <select id="periodCountSelector"></select>

    <label for="monthSelector">ğŸ—“ï¸ æª¢æŸ¥æœˆä»½ï¼š</label>
    <select id="monthSelector"></select>
  </div>

  <input type="file" id="excelFile" accept=".xls,.xlsx" />
  <button onclick="exportScheduleToExcel()">ğŸ“¤ åŒ¯å‡ºç­è¡¨çµæœ</button>
  <button onclick="toggleSettingPanel()">âš™ï¸ è¨­å®š</button>

  <div id="customShiftSetting" style="display:none; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-top:10px;">
    <h3>è‡ªè¨‚ç­åˆ¥ä»£è™Ÿï¼ˆé€±æœŸèˆ‡æœˆçµ±è¨ˆå…±ç”¨ï¼‰</h3>
    <div id="shiftGroupEditor"></div>
    <button onclick="saveShiftGroups()">ğŸ’¾ å„²å­˜è¨­å®š</button>
  </div>

  <div id="weeklyTableContainer" class="table-container"></div>
  <div id="monthlyTableContainer" class="table-container"></div>

  <script src="config.js"></script>
  <script src="periodStartSelector.js"></script>
  <script src="periodCountSelector.js"></script>
  <script src="monthSelector.js"></script>
  <script src="ui.js"></script>
  <script src="excelLoader.js"></script>
  <script src="tableRenderer.js"></script>
  <script src="checker.js"></script>
  <script src="modeSelector.js"></script>

  <script>
    window.onload = function () {
      const today = new Date();
      renderPeriodStartSelector(today);
      renderPeriodCountSelector();
      renderMonthSelector();
      initModeSelector();

      window.scheduleState = {
        startDate: document.getElementById("periodStartSelector").value,
        periodCount: parseInt(document.getElementById("periodCountSelector").value, 10),
        monthStr: document.getElementById("monthSelector").value,
        selectedRows: []
      };
    };

    ["periodCountSelector", "periodStartSelector", "monthSelector"].forEach(id => {
      document.getElementById(id).addEventListener("change", () => {
        const state = window.scheduleState;
        state.startDate = document.getElementById("periodStartSelector").value;
        state.periodCount = parseInt(document.getElementById("periodCountSelector").value, 10);
        state.monthStr = document.getElementById("monthSelector").value;

        if (state.selectedRows.length && typeof window.renderScheduleTable === "function") {
          window.renderScheduleTable(state.selectedRows);
        }
      });
    });

    document.getElementById("excelFile").addEventListener("change", function () {
      if (this.files.length > 0) {
        handleExcelImport();
      }
    });

    document.getElementById("checkboxWeekly").addEventListener("change", () => {
      if (window.scheduleState?.selectedRows?.length) {
        window.renderScheduleTable(window.scheduleState.selectedRows);
      }
    });

    document.getElementById("checkboxMonthly").addEventListener("change", () => {
      if (window.scheduleState?.selectedRows?.length) {
        window.renderScheduleTable(window.scheduleState.selectedRows);
      }
    });

    document.getElementById("info-toggle").addEventListener("click", function () {
      const infoContent = document.getElementById("info-content");
      infoContent.style.display = (infoContent.style.display === "none" || infoContent.style.display === "") ? "block" : "none";
    });

    // âœ… è‡ªè¨‚ç­åˆ¥ä»£è™Ÿè¨­å®šï¼ˆå…±ç”¨æ–¼é€±æœŸèˆ‡æœˆçµ±è¨ˆï¼‰
    const fixedShiftFields = ["OFF", "WW", "å°å¤œ", "å¤§å¤œ"];

    const defaultShiftGroups = {
      OFF: ["FF", "WW", "VV", "SS"],
      WW: ["WW", "4W", "8W", "12W", "DLW", "5GW"],
      å°å¤œ: ["4", "4N", "4N1"],
      å¤§å¤œ: ["12", "12W"]
    };

    function loadShiftGroups() {
      const raw = localStorage.getItem("shiftGroups");
      try {
        const parsed = raw ? JSON.parse(raw) : structuredClone(defaultShiftGroups);
        fixedShiftFields.forEach(field => {
          if (!parsed[field]) parsed[field] = structuredClone(defaultShiftGroups[field]);
        });
        return parsed;
      } catch {
        return structuredClone(defaultShiftGroups);
      }
    }

    function saveShiftGroupsToLocal(groups) {
      localStorage.setItem("shiftGroups", JSON.stringify(groups));
    }

    function toggleSettingPanel() {
      const panel = document.getElementById("customShiftSetting");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
      renderShiftGroupEditor();
    }

    function renderShiftGroupEditor() {
      const groups = loadShiftGroups();
      const container = document.getElementById("shiftGroupEditor");
      container.innerHTML = "";

      fixedShiftFields.forEach(field => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-block";

        const label = document.createElement("div");
        label.textContent = `æ¬„ä½åç¨±ï¼š${field}`;
        label.style.fontWeight = "bold";
        label.style.marginBottom = "6px";

        const codeList = document.createElement("ul");
        codeList.className = "code-list";

        groups[field].forEach(code => {
          const li = document.createElement("li");
          li.innerHTML = `
            <input type="text" value="${code}" class="code-input" />
            <button onclick="removeCode(this)">ğŸ—‘ï¸</button>
          `;
          codeList.appendChild(li);
        });

        const addCodeBtn = document.createElement("button");
        addCodeBtn.textContent = "â• æ–°å¢ä»£è™Ÿ";
        addCodeBtn.onclick = () => {
          const li = document.createElement("li");
          li.innerHTML = `
            <input type="text" value="" class="code-input" />
            <button onclick="removeCode(this)">ğŸ—‘ï¸</button>
          `;
          codeList.appendChild(li);
        };

        groupDiv.appendChild(label);
        groupDiv.appendChild(codeList);
        groupDiv.appendChild(addCodeBtn);
        container.appendChild(groupDiv);
      });
    }

    function removeCode(btn) {
      const li = btn.parentElement;
      const ul = li.parentElement;
      if (ul.querySelectorAll("li").length > 1) {
        ul.removeChild(li);
      } else {
        alert("æ¯é …è‡³å°‘ä¿ç•™ä¸€å€‹ä»£è™Ÿï¼");
      }
    }

    function saveShiftGroups() {
      const groupBlocks = document.querySelectorAll(".group-block");
      const newGroups = {};

      groupBlocks.forEach((block, index) => {
        const field = fixedShiftFields[index];
        const codes = Array.from(block.querySelectorAll(".code-input"))
          .map(input => input.value.trim())
          .filter(Boolean);

        if (codes.length > 0) {
          newGroups[field] = codes;
        } else {
          alert(`æ¬„ä½ã€Œ${field}ã€è‡³å°‘è¦æœ‰ä¸€å€‹ä»£è™Ÿï¼`);
          return;
        }
      });

      saveShiftGroupsToLocal(newGroups);
      alert("âœ… ç­åˆ¥è¨­å®šå·²å„²å­˜ï¼");
  // ğŸ‘‰ æ–°å¢é€™ä¸€è¡Œï¼šå„²å­˜å¾Œé—œé–‰è¨­å®šé¢æ¿
  document.getElementById("customShiftSetting").style.display = "none";

    }
  </script>
</body>
</html>